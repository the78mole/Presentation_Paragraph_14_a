name: Build LaTeX document
on:
  push:
    tags:
      - "v*"
  pull_request:

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit checks
        run: pre-commit run --all-files --show-diff-on-failure

  build_latex:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Holt alle Commits und Tags

      # Workaround for Windows devcontainer issue
      - name: Make script executable
        run: chmod +x ./scripts/generate-release-notes.sh

      - name: Set version name
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ðŸ“ This is a pull request build with PR #${{ github.event.pull_request.number }}."
            echo "name=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "ðŸ·ï¸ This is a tag build with ref ${{ github.ref_name }}"
            echo "name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Generate Release Notes
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          ./scripts/generate-release-notes.sh release-notes.md "${{ github.ref_name }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compile LaTeX document
        #uses: xu-cheng/latex-action@v4
        uses: dante-ev/latex-action@latest
        with:
          root_file: Paragraph_14a.tex
          #compiler: pdflatex
          #args: -pdf
          #args: "-pdf -latexoption=-file-line-error -latexoption=-interaction=nonstopmode"
          #args: -interaction=nonstopmode -pdf -file-line-error
          #args: -interaction=nonstopmode -shell-escape
          #args: -synctex=0 -interaction=nonstopmode --shell-escape -pdf -file-line-error

      - name: Rename PDF
        run: |
          echo "ðŸ“„ Renaming PDF to include version name: ${{ steps.version.outputs.name }}"
          mv Paragraph_14a.pdf Paragraph_14a_${{ steps.version.outputs.name }}.pdf

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: Presentation.pdf
          path: Paragraph_14a_${{ steps.version.outputs.name }}.pdf

      - name: Create GitHub Release
        if: ${{ startsWith(github.ref, 'refs/tags/') && !env.ACT }}
        uses: softprops/action-gh-release@v2
        with:
          name: "Presentation_${{ github.ref_name }}"
          body_path: release-notes.md
          files: Paragraph_14a_${{ steps.version.outputs.name }}.pdf
          fail_on_unmatched_files: true
