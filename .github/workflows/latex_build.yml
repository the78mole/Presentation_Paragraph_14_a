name: Build LaTeX document
on:
  push:
    tags:
      - "v*"
  pull_request:

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install pre-commit
        run: uv tool install pre-commit

      - name: Run pre-commit checks
        run: uv tool run pre-commit run --all-files --show-diff-on-failure

      - name: Commit auto-fixes
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # PrÃ¼fe, ob der letzte Commit vom Bot war
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$LAST_COMMIT_MSG" == *"style: apply pre-commit auto-fixes"* ]]; then
            echo "âš ï¸ Last commit was already an auto-fix commit. Skipping to prevent loop."
            exit 0
          fi

          # PrÃ¼fe ob es Ã¼berhaupt Ã„nderungen gibt
          if [[ -z $(git status --porcelain) ]]; then
            echo "â„¹ï¸ No changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "style: apply pre-commit auto-fixes"
          git push

  build_latex:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Holt alle Commits und Tags

      - name: Set version name
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ðŸ“ This is a pull request build with PR #${{ github.event.pull_request.number }}."
            echo "name=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "ðŸ·ï¸ This is a tag build with ref ${{ github.ref_name }}"
            echo "name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Compile LaTeX document
        uses: dante-ev/latex-action@latest
        with:
          root_file: Paragraph_14a.tex

      - name: Rename PDF
        run: |
          echo "ðŸ“„ Renaming PDF to include version name: ${{ steps.version.outputs.name }}"
          mv Paragraph_14a.pdf Paragraph_14a_${{ steps.version.outputs.name }}.pdf

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: Presentation.pdf
          path: Paragraph_14a_${{ steps.version.outputs.name }}.pdf

  release:
    runs-on: ubuntu-latest
    needs: build_latex
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Make script executable
        run: chmod +x ./scripts/generate-release-notes.sh

      - name: Generate Release Notes
        run: |
          ./scripts/generate-release-notes.sh release-notes.md "${{ github.ref_name }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download PDF artifact
        uses: actions/download-artifact@v4
        with:
          name: Presentation.pdf

      - name: Create GitHub Release
        if: ${{ !env.ACT }}
        uses: softprops/action-gh-release@v2
        with:
          name: "Presentation_${{ github.ref_name }}"
          body_path: release-notes.md
          files: Paragraph_14a_${{ github.ref_name }}.pdf
          fail_on_unmatched_files: true
